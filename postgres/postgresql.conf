# PostgreSQL configuration for Ocean Shopping Center
# Optimized for production workload with high concurrency

# CONNECTIONS AND AUTHENTICATION
max_connections = 200                    # Max concurrent connections
superuser_reserved_connections = 3       # Reserve connections for superuser

# RESOURCE USAGE (except WAL)
shared_buffers = 512MB                   # 25% of available RAM for 2GB container
work_mem = 8MB                           # Memory for internal sort operations and hash tables
maintenance_work_mem = 128MB             # Memory for maintenance operations
effective_cache_size = 1536MB            # OS and database cache estimate (75% of RAM)

# Connection pooling
tcp_keepalives_idle = 600               # TCP keepalive timeout
tcp_keepalives_interval = 30
tcp_keepalives_count = 3

# WRITE AHEAD LOG
wal_buffers = 16MB                       # Buffer amount for WAL data
max_wal_size = 2GB                       # Maximum size to let WAL grow
min_wal_size = 512MB                     # Minimum WAL file size
checkpoint_completion_target = 0.9       # Time to complete checkpoint (0-1)
checkpoint_timeout = 15min               # Maximum time between checkpoints

# WAL archiving for backup/replication
archive_mode = on
archive_command = '/bin/true'            # Placeholder, configure for actual archiving

# QUERY TUNING
random_page_cost = 1.1                   # Cost of non-sequentially-fetched disk page
effective_io_concurrency = 200           # Number of concurrent disk I/O operations
default_statistics_target = 100          # Statistics collection target

# LOGGING
log_destination = 'stderr'
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_min_duration_statement = 1000        # Log slow queries (1 second)
log_lock_waits = on                      # Log long lock waits
log_temp_files = 10MB                    # Log temp files larger than 10MB
log_checkpoints = on                     # Log checkpoint activities
log_connections = on                     # Log successful connections
log_disconnections = on                  # Log session terminations
log_statement = 'ddl'                    # Log DDL statements

# RUNTIME STATISTICS
shared_preload_libraries = 'pg_stat_statements'
track_activities = on
track_counts = on
track_io_timing = on                     # Enable timing of database I/O calls
track_functions = pl                     # Track function call counts

# pg_stat_statements configuration
pg_stat_statements.max = 10000          # Maximum number of statements tracked
pg_stat_statements.track = all          # Track all statements
pg_stat_statements.save = on            # Save statistics across restarts

# AUTOVACUUM
autovacuum = on                         # Enable autovacuum daemon
autovacuum_max_workers = 4              # Max autovacuum processes
autovacuum_naptime = 15s                # Sleep time between autovacuum runs
autovacuum_vacuum_threshold = 50        # Min number of tuple updates/deletes before vacuum
autovacuum_analyze_threshold = 50       # Min number of tuple inserts/updates/deletes before analyze
autovacuum_vacuum_scale_factor = 0.1    # Fraction of table size before vacuum
autovacuum_analyze_scale_factor = 0.05  # Fraction of table size before analyze
autovacuum_vacuum_cost_delay = 10ms     # Vacuum cost delay
autovacuum_vacuum_cost_limit = 1000     # Vacuum cost limit

# CLIENT CONNECTION DEFAULTS
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# LOCK MANAGEMENT
max_locks_per_transaction = 64          # Max locks per transaction
max_pred_locks_per_transaction = 64     # Max predicate locks per transaction
deadlock_timeout = 1s                   # Time to wait before checking for deadlocks

# ERROR REPORTING AND LOGGING
log_min_error_statement = error         # Log statements causing errors
log_error_verbosity = default           # Amount of detail in logged messages

# PERFORMANCE OPTIMIZATION
enable_seqscan = on                     # Enable sequential scans
enable_indexscan = on                   # Enable index scans
enable_indexonlyscan = on              # Enable index-only scans
enable_bitmapscan = on                 # Enable bitmap scans
enable_hashjoin = on                   # Enable hash joins
enable_nestloop = on                   # Enable nested-loop joins
enable_mergejoin = on                  # Enable merge joins
enable_hashagg = on                    # Enable hash aggregation
enable_sort = on                       # Enable explicit sort steps

# PARALLEL QUERY SETTINGS
max_parallel_workers_per_gather = 2     # Max parallel workers per Gather node
max_parallel_workers = 4                # Max parallel workers system-wide
parallel_tuple_cost = 0.1              # Cost of transferring one tuple via parallel communication
parallel_setup_cost = 1000             # Cost of setting up parallel query

# SECURITY
ssl = off                              # SSL handled by nginx reverse proxy
password_encryption = scram-sha-256    # Password encryption method

# CUSTOM SETTINGS FOR OCEAN SHOPPING CENTER
# Optimize for read-heavy e-commerce workload with moderate writes
seq_page_cost = 1.0                    # Cost of sequential page fetch
cpu_tuple_cost = 0.01                  # Cost of processing each row
cpu_index_tuple_cost = 0.005           # Cost of processing each index entry
cpu_operator_cost = 0.0025             # Cost of processing each operator/function

# Connection and session optimizations
statement_timeout = 30000              # 30 second statement timeout
idle_in_transaction_session_timeout = 300000  # 5 minute idle transaction timeout
lock_timeout = 10000                   # 10 second lock timeout

# Memory settings for e-commerce workload
temp_buffers = 32MB                    # Temporary buffer memory
max_prepared_transactions = 0          # Disabled for better performance