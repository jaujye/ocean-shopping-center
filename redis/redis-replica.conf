# Redis Configuration for Ocean Shopping Center - Replica Node
# Optimized for read performance and replication

# GENERAL CONFIGURATION
bind 0.0.0.0
port 6379
timeout 0
tcp-keepalive 300

# REPLICATION - This is a replica node
replicaof redis-master 6379
requirepass ${REDIS_PASSWORD}
masterauth ${REDIS_PASSWORD}

# PERSISTENCE - Minimal persistence for replica
save 1800 1     # Save every 30 minutes if at least 1 key changed
save 300 100    # Save after 5 minutes if at least 100 keys changed

# RDB Options
rdbcompression yes
rdbchecksum yes
dbfilename dump-replica.rdb
dir /data

# AOF disabled for replica (master handles persistence)
appendonly no

# MEMORY MANAGEMENT
maxmemory 384MB                    # Smaller memory allocation for replica
maxmemory-policy allkeys-lru       # Remove least recently used keys
maxmemory-samples 5               # LRU sample size

# PERFORMANCE TUNING
tcp-backlog 511
databases 16
hz 10

# CLIENT MANAGEMENT
maxclients 5000                   # Fewer max clients for replica
timeout 0

# NETWORK OPTIMIZATION
tcp-keepalive 300
tcp-nodelay yes

# LOGGING
loglevel notice
logfile /var/log/redis/redis-replica.log
syslog-enabled no

# SLOW LOG
slowlog-log-slower-than 10000
slowlog-max-len 512               # Smaller slow log for replica

# LATENCY MONITORING
latency-monitor-threshold 100

# REPLICATION SETTINGS (Replica)
replica-serve-stale-data yes      # Serve stale data when replication link is down
replica-read-only yes             # Replica is read-only
repl-diskless-load yes           # Enable diskless loading
repl-ping-replica-period 10
repl-timeout 60
repl-disable-tcp-nodelay no
replica-priority 100             # Replica priority for sentinel

# SECURITY  
rename-command FLUSHDB ""         # Disable dangerous commands
rename-command FLUSHALL ""
rename-command DEBUG ""
rename-command CONFIG "CONFIG_9a2f8b1c3d4e5f67890abcdef"

# CLIENT OUTPUT BUFFER LIMITS
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256MB 64MB 60
client-output-buffer-limit pubsub 32MB 8MB 60

# ADVANCED CONFIGURATION - Same as master for consistency
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog optimization
hll-sparse-max-bytes 3000

# Streams optimization
stream-node-max-bytes 4KB
stream-node-max-entries 100

# ACTIVE REHASHING
activerehashing yes

# DEFRAGMENTATION (Reduced for replica)
activedefrag yes
active-defrag-ignore-bytes 50MB   # Lower threshold for replica
active-defrag-threshold-lower 5
active-defrag-threshold-upper 50
active-defrag-cycle-min 1
active-defrag-cycle-max 25

# THREADING (Redis 6.0+)
io-threads 2                     # Fewer threads for replica
io-threads-do-reads yes

# MEMORY USAGE OPTIMIZATION
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# GOPHER PROTOCOL (Disabled)
gopher-enabled no

# READ-ONLY OPTIMIZATIONS FOR REPLICA
# Disable write commands that are not needed
rename-command SET ""
rename-command DEL ""
rename-command UNLINK ""
rename-command INCR ""
rename-command DECR ""
rename-command INCRBY ""
rename-command DECRBY ""
rename-command INCRBYFLOAT ""
rename-command APPEND ""
rename-command LPUSH ""
rename-command RPUSH ""
rename-command LPOP ""
rename-command RPOP ""
rename-command SADD ""
rename-command SREM ""
rename-command SPOP ""
rename-command ZADD ""
rename-command ZREM ""
rename-command HSET ""
rename-command HDEL ""
rename-command EXPIRE ""
rename-command EXPIREAT ""
rename-command PEXPIRE ""
rename-command PEXPIREAT ""

# OCEAN SHOPPING CENTER SPECIFIC OPTIMIZATIONS
# Read-optimized settings for product catalog and session data
hash-max-ziplist-entries 1024
hash-max-ziplist-value 128
list-max-ziplist-size -1
list-compress-depth 1
zset-max-ziplist-entries 256
zset-max-ziplist-value 128

# Keyspace notifications disabled on replica to reduce overhead
notify-keyspace-events ""

# LUA Script settings
lua-time-limit 5000

# Protected mode
protected-mode no

# Supervised mode
supervised no

# REPLICA-SPECIFIC PERFORMANCE SETTINGS
replica-lazy-flush yes           # Enable lazy flush for replica
replica-read-only yes            # Ensure read-only mode
replica-serve-stale-data yes     # Serve stale data during disconnection
replica-ignore-maxmemory yes     # Ignore maxmemory settings during replication