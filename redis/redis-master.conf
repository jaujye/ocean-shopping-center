# Redis Configuration for Ocean Shopping Center - Master Node
# Optimized for high performance caching and session storage

# GENERAL CONFIGURATION
bind 0.0.0.0
port 6379
timeout 0
tcp-keepalive 300

# PERSISTENCE - Optimized for performance over durability
save 900 1      # Save after 900 seconds if at least 1 key changed
save 300 10     # Save after 300 seconds if at least 10 keys changed  
save 60 10000   # Save after 60 seconds if at least 10000 keys changed

# RDB Options
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /data

# AOF disabled for better performance in cache scenarios
appendonly no

# MEMORY MANAGEMENT
maxmemory 768MB                    # Leave some memory for OS
maxmemory-policy allkeys-lru       # Remove least recently used keys
maxmemory-samples 5               # LRU sample size

# PERFORMANCE TUNING
tcp-backlog 511                   # TCP listen backlog
databases 16                      # Number of databases
hz 10                            # Background task frequency

# CLIENT MANAGEMENT  
maxclients 10000                  # Maximum number of clients
timeout 0                         # Client idle timeout (0 = disable)

# NETWORK OPTIMIZATION
tcp-keepalive 300                 # TCP keepalive
tcp-nodelay yes                   # Disable Nagle algorithm

# LOGGING
loglevel notice
logfile /var/log/redis/redis-master.log
syslog-enabled no

# SLOW LOG
slowlog-log-slower-than 10000     # Log queries slower than 10ms
slowlog-max-len 1024              # Max entries in slow log

# LATENCY MONITORING
latency-monitor-threshold 100     # Monitor operations taking longer than 100ms

# REPLICATION SETTINGS (Master)
repl-diskless-sync yes           # Enable diskless replication
repl-diskless-sync-delay 5       # Delay before starting diskless replication
repl-ping-replica-period 10      # Ping replicas every 10 seconds
repl-timeout 60                  # Replication timeout
repl-disable-tcp-nodelay no      # Enable TCP_NODELAY for replication
repl-backlog-size 16MB           # Replication backlog size
repl-backlog-ttl 3600           # Replication backlog TTL

# SECURITY
requirepass ${REDIS_PASSWORD}
rename-command FLUSHDB ""        # Disable dangerous commands
rename-command FLUSHALL ""
rename-command DEBUG ""
rename-command CONFIG "CONFIG_9a2f8b1c3d4e5f67890abcdef"

# CLIENT OUTPUT BUFFER LIMITS
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256MB 64MB 60
client-output-buffer-limit pubsub 32MB 8MB 60

# ADVANCED CONFIGURATION
hash-max-ziplist-entries 512     # Hash optimization
hash-max-ziplist-value 64
list-max-ziplist-size -2         # List optimization
list-compress-depth 0
set-max-intset-entries 512       # Set optimization
zset-max-ziplist-entries 128     # Sorted set optimization
zset-max-ziplist-value 64

# HyperLogLog optimization
hll-sparse-max-bytes 3000

# Streams optimization  
stream-node-max-bytes 4KB
stream-node-max-entries 100

# ACTIVE REHASHING
activerehashing yes

# DEFRAGMENTATION (Redis 4.0+)
activedefrag yes
active-defrag-ignore-bytes 100MB
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 5
active-defrag-cycle-max 75

# THREADING (Redis 6.0+) 
io-threads 4                     # Enable multi-threading for I/O
io-threads-do-reads yes          # Enable threaded reads

# MEMORY USAGE OPTIMIZATION
lazyfree-lazy-eviction yes       # Enable lazy freeing for evicted keys
lazyfree-lazy-expire yes         # Enable lazy freeing for expired keys
lazyfree-lazy-server-del yes     # Enable lazy freeing for server deletions
replica-lazy-flush yes           # Enable lazy flush for replica

# GOPHER PROTOCOL (Disabled)
gopher-enabled no

# MODULES
# loadmodule /path/to/module.so

# OCEAN SHOPPING CENTER SPECIFIC OPTIMIZATIONS
# Session storage optimization
hash-max-ziplist-entries 1024   # Increase for session data
hash-max-ziplist-value 128      # Increase for session data

# Shopping cart optimization  
list-max-ziplist-size -1        # Optimize for cart items
list-compress-depth 1          # Light compression for cart history

# Product cache optimization
zset-max-ziplist-entries 256    # Optimize for product rankings
zset-max-ziplist-value 128     # Optimize for product data

# Keyspace notifications for real-time updates
notify-keyspace-events "Ex"     # Enable keyspace events for expiration

# LUA Script caching
lua-time-limit 5000            # Lua script execution limit (5 seconds)

# Protected mode (disabled in container environment)
protected-mode no

# Supervised mode  
supervised no